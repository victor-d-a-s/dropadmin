<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drop Admin - Painel Mestre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .sidebar { width: 260px; height: 100vh; background: #111827; color: white; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; z-index: 50; }
        .content { margin-left: 260px; padding: 30px; transition: 0.3s; }
        .nav-item { padding: 16px 24px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; color: #9CA3AF; font-size: 14px; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #1F2937; color: #FBBF24; border-right: 3px solid #FBBF24; }
        
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .b-pendente { background: #FEF3C7; color: #D97706; }
        .b-aprovado { background: #D1FAE5; color: #059669; }
        .b-bloqueado { background: #FEE2E2; color: #DC2626; }
        
        .modal-bg { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .pin-input { letter-spacing: 0.5em; font-family: monospace; text-align: center; font-size: 24px; }
        
        /* Tabela Contábil */
        .table-head { background-color: #F9FAFB; color: #6B7280; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
        tr:hover td { background-color: #F9FAFB; }
        td { border-bottom: 1px solid #E5E7EB; padding: 12px 16px; font-size: 0.875rem; }

        @media (max-width: 768px) { .sidebar { width: 70px; } .sidebar span, .logo-text { display: none; } .content { margin-left: 70px; padding: 15px; } }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-2xl w-96 text-center border border-gray-700 shadow-2xl">
            <i class="fas fa-user-shield text-5xl text-yellow-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-white mb-6">Acesso Mestre</h2>
            <input type="email" id="adm-email" class="w-full bg-gray-900 border border-gray-600 text-white p-3 rounded-lg mb-3" placeholder="E-mail Admin">
            <input type="password" id="adm-senha" class="w-full bg-gray-900 border border-gray-600 text-white p-3 rounded-lg mb-6" placeholder="Senha">
            <button onclick="loginAdmin()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-lg">ENTRAR</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        
        <div class="sidebar">
            <div class="p-6 border-b border-gray-800 flex items-center gap-3">
                <div class="bg-yellow-500 p-2 rounded-lg text-black"><i class="fas fa-cube"></i></div>
                <span class="font-bold text-lg tracking-wide logo-text">DROP <span class="text-yellow-500">ADMIN</span></span>
            </div>
            
            <div class="flex-1 py-6 space-y-1 overflow-y-auto">
                <div class="nav-item active" onclick="nav('dash', this); carregarFinanceiro()"><i class="fas fa-chart-line"></i> <span>Financeiro & Borderô</span></div>
                <div class="nav-item" onclick="nav('pedidos', this); carregarPedidos()"><i class="fas fa-receipt"></i> <span>Pedidos Live</span></div>
                <div class="nav-item" onclick="nav('motoboys', this); carregarMotoboys()"><i class="fas fa-motorcycle"></i> <span>Entregadores</span></div>
                <div class="nav-item" onclick="nav('avaliacoes', this); carregarAvaliacoes()"><i class="fas fa-star"></i> <span>Avaliações</span></div>
                <div class="nav-item" onclick="nav('lojas', this); carregarLojas()"><i class="fas fa-store"></i> <span>Lojas & Saldo</span></div>
                <div class="nav-item" onclick="nav('config', this); carregarConfig()"><i class="fas fa-cog"></i> <span>Configurações</span></div>
                <div class="nav-item" onclick="nav('perfil', this); carregarPerfil()"><i class="fas fa-user-shield"></i> <span>Perfil & Segurança</span></div>
            </div>
            
            <div class="p-4 border-t border-gray-800">
                <div class="nav-item text-red-400 hover:bg-red-900/20 hover:text-red-300 transition" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> <span>Sair do Sistema</span>
                </div>
            </div>
        </div>

        <div class="content">
            
            <div id="view-dash" class="fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Relatório Contábil</h1>
                        <p class="text-xs text-gray-500">Geração de Borderô para evitar bitributação.</p>
                    </div>
                    <div class="flex flex-wrap gap-2 bg-white p-2 rounded-lg shadow-sm items-center">
                        <input type="date" id="data-inicio" class="border rounded px-2 py-1 text-sm">
                        <span class="text-gray-400 self-center">até</span>
                        <input type="date" id="data-fim" class="border rounded px-2 py-1 text-sm">
                        <button onclick="carregarFinanceiro()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold hover:bg-blue-700">Filtrar</button>
                        <button onclick="exportarCSV()" class="bg-green-600 text-white px-4 py-1 rounded text-sm font-bold hover:bg-green-700"><i class="fas fa-file-excel mr-1"></i> CSV</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-gray-500">
                        <p class="text-gray-400 text-xs font-bold uppercase">Entrada Total (Conta Transitória)</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-1" id="fin-total">R$ 0,00</h2>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-red-500 text-xs font-bold uppercase">Repasse a Terceiros (Obrigação)</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-1" id="fin-motoboys">R$ 0,00</h2>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-green-600 text-xs font-bold uppercase">Receita Real (Taxa App)</p>
                        <h2 class="text-3xl font-bold text-gray-800 mt-1" id="fin-app">R$ 0,00</h2>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200"><h3 class="font-bold text-gray-700">Detalhamento de Transações</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="table-head">
                                <tr>
                                    <th class="p-4">ID / Data</th>
                                    <th class="p-4">Rota</th>
                                    <th class="p-4 text-blue-600">Entrada (Total)</th>
                                    <th class="p-4 text-red-500">Repasse (Saída)</th>
                                    <th class="p-4 text-green-600">Taxa (Receita)</th>
                                </tr>
                            </thead>
                            <tbody id="lista-financeiro" class="text-sm text-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-pedidos" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold text-gray-800">Monitor Ao Vivo</h1><button onclick="carregarPedidos()" class="text-blue-600 hover:underline text-sm"><i class="fas fa-sync"></i> Atualizar</button></div>
                <div id="lista-pedidos" class="space-y-3"></div>
            </div>

            <div id="view-motoboys" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Gestão de Entregadores</h1>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase">
                            <tr><th class="p-4">Nome</th><th class="p-4">Veículo</th><th class="p-4">WhatsApp</th><th class="p-4">Cadastro</th></tr>
                        </thead>
                        <tbody id="lista-motos" class="text-sm text-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-avaliacoes" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Avaliações Recentes</h1>
                <div id="lista-avaliacoes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>

            <div id="view-lojas" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Lojas e Financeiro</h1>
                <div class="mb-4"><input type="text" id="busca-loja" onkeyup="filtrarLojas()" placeholder="Buscar loja..." class="w-full p-3 border rounded-lg bg-white shadow-sm outline-none focus:border-blue-500"></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase">
                            <tr><th class="p-4">Loja</th><th class="p-4">Responsável</th><th class="p-4">Saldo</th><th class="p-4 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="lista-lojas" class="text-sm text-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-config" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Configurações Globais</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit">
                        <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">Custo para o Cliente</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">Taxa Base (Início)</label>
                                <div class="relative"><span class="absolute left-3 top-3 text-gray-400">R$</span><input type="number" id="cfg-base" step="0.50" class="w-full border p-3 pl-10 rounded-lg"></div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">Preço por KM</label>
                                <div class="relative"><span class="absolute left-3 top-3 text-gray-400">R$</span><input type="number" id="cfg-km" step="0.10" class="w-full border p-3 pl-10 rounded-lg"></div>
                            </div>
                            
                            <div class="pt-4 border-t">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Taxa de Retorno</label>
                                <div class="flex items-center gap-4 mb-2">
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="tipo_retorno" value="percent" class="w-4 h-4 text-blue-600" checked><span class="text-sm">Porcentagem (%)</span></label>
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="tipo_retorno" value="fixed" class="w-4 h-4 text-blue-600"><span class="text-sm">Valor Fixo (R$)</span></label>
                                </div>
                                <input type="number" id="cfg-retorno-valor" class="w-full border p-3 rounded-lg text-blue-700 font-bold" placeholder="Ex: 20">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm h-fit border border-green-100">
                        <h3 class="font-bold text-green-700 border-b pb-2 mb-4">Comissão do App (Drop)</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Cobrança</label>
                            <div class="flex items-center gap-4 mb-3">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="tipo_taxa" value="percent" class="w-4 h-4 text-green-600" checked><span class="text-sm">Porcentagem (%)</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="tipo_taxa" value="fixed" class="w-4 h-4 text-green-600"><span class="text-sm">Valor Fixo (R$)</span></label>
                            </div>
                            <input type="number" id="cfg-taxa-app" class="w-full border p-3 rounded-lg text-green-700 font-bold text-lg" placeholder="Valor">
                        </div>
                        <button onclick="verificarPinParaAcao(salvarConfig)" class="w-full bg-gray-800 text-white font-bold py-4 rounded-lg hover:bg-black mt-6 shadow-lg"><i class="fas fa-save mr-2"></i> SALVAR PREÇOS (PIN)</button>
                    </div>
                </div>
            </div>

            <div id="view-perfil" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Perfil & Segurança</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Alterar Senha Login</h3>
                        <input type="password" id="perf-senha-nova" class="w-full border p-3 rounded-lg mb-3" placeholder="Nova Senha">
                        <button onclick="alterarSenhaLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">Atualizar Senha</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-red-100">
                        <h3 class="font-bold text-red-600 mb-4 border-b pb-2">Alterar PIN Mestre</h3>
                        <input type="password" id="perf-pin-atual" class="w-full border p-3 rounded-lg text-center mb-2" placeholder="PIN Atual" maxlength="4">
                        <input type="password" id="perf-pin-novo" class="w-full border p-3 rounded-lg text-center font-bold mb-3" placeholder="Novo PIN" maxlength="4">
                        <button onclick="alterarPinSeguranca()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg">Atualizar PIN</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-create-pin" class="hidden fixed inset-0 modal-bg z-[80] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center border-t-4 border-red-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Segurança Obrigatória</h2>
            <p class="text-sm text-gray-500 mb-6">Crie um <b>PIN Mestre (4 dígitos)</b>. Ele será exigido para mexer em dinheiro e configs.</p>
            <input type="tel" id="new-master-pin" maxlength="4" class="w-full border-2 border-gray-300 rounded-xl p-4 pin-input mb-6 focus:border-red-500 outline-none" placeholder="0000">
            <button onclick="criarPinInicial()" class="w-full bg-red-600 text-white font-bold py-4 rounded-xl hover:bg-red-700 text-lg">DEFINIR PIN</button>
        </div>
    </div>

    <div id="modal-pin-check" class="hidden fixed inset-0 modal-bg z-[70] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center">
            <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-2xl"><i class="fas fa-lock"></i></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Acesso Restrito</h3>
            <input type="password" id="input-check-pin" maxlength="4" class="w-full border-2 border-gray-300 rounded-xl p-4 pin-input mb-6 focus:border-red-500 outline-none" placeholder="••••">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="fecharModalPin()" class="bg-gray-200 text-gray-700 font-bold py-3 rounded-xl">Cancelar</button>
                <button onclick="confirmarPinAcao()" class="bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modal-saldo" class="hidden fixed inset-0 modal-bg z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-1">Gerenciar Saldo</h3>
            <p id="modal-loja-nome" class="text-sm text-gray-500 mb-4">Loja...</p>
            <div class="flex gap-2 mb-3">
                <button onclick="setTipoSaldo('credito')" id="btn-credito" class="flex-1 py-2 bg-green-100 text-green-700 rounded-lg font-bold border border-green-200">Adicionar</button>
                <button onclick="setTipoSaldo('debito')" id="btn-debito" class="flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg font-bold border border-transparent">Remover</button>
            </div>
            <input type="number" id="input-saldo" class="w-full border p-3 rounded-lg text-lg mb-4 font-bold text-gray-800" placeholder="0.00">
            <button onclick="verificarPinParaAcao(confirmarSaldo)" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">Confirmar (Requer PIN)</button>
            <button onclick="document.getElementById('modal-saldo').classList.add('hidden')" class="w-full mt-2 py-2 text-gray-500 text-sm">Cancelar</button>
            <input type="hidden" id="modal-loja-id"><input type="hidden" id="modal-tipo-saldo" value="credito">
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ofpnnijkhgsjarixoyhg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mcG5uaWpraGdzamFyaXhveWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNjUyNzYsImV4cCI6MjA4MDY0MTI3Nn0.dNOIIETmTz3l1HvhuT-ihAiymJqiaYZnklzzBzDGCFU';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let acaoPendente = null;
        let cacheRelatorio = []; // Guarda dados para CSV

        // --- AUTH & INIT ---
        window.onload = async () => {
            const { data: { session } } = await sbClient.auth.getSession();
            if(session) initSystem();
            
            const hoje = new Date(); 
            const mesAtras = new Date(); mesAtras.setDate(hoje.getDate() - 30);
            document.getElementById('data-fim').valueAsDate = hoje; 
            document.getElementById('data-inicio').valueAsDate = mesAtras;
        };

        async function loginAdmin() {
            const email = document.getElementById('adm-email').value;
            const senha = document.getElementById('adm-senha').value;
            const { error } = await sbClient.auth.signInWithPassword({ email, password: senha });
            if(error) alert(error.message); else initSystem();
        }
        function logout() { sbClient.auth.signOut(); location.reload(); }

        async function initSystem() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            await verificarPinInicial();
            carregarFinanceiro(); // Carrega tela inicial
        }

        // --- PIN SYSTEM ---
        async function verificarPinInicial() {
            const { data } = await sbClient.from('app_config').select('admin_pin, id').single();
            if(!data) { await sbClient.from('app_config').insert({}); document.getElementById('modal-create-pin').classList.remove('hidden'); }
            else if (!data.admin_pin || data.admin_pin === '0000') document.getElementById('modal-create-pin').classList.remove('hidden');
        }
        async function criarPinInicial() {
            const pin = document.getElementById('new-master-pin').value;
            if(pin.length !== 4) return alert("Digite 4 números.");
            const { data } = await sbClient.from('app_config').select('id').limit(1).single();
            if(data) { await sbClient.from('app_config').update({ admin_pin: pin }).eq('id', data.id); document.getElementById('modal-create-pin').classList.add('hidden'); }
        }
        function verificarPinParaAcao(callback) { acaoPendente = callback; document.getElementById('input-check-pin').value = ''; document.getElementById('modal-pin-check').classList.remove('hidden'); document.getElementById('input-check-pin').focus(); }
        function fecharModalPin() { document.getElementById('modal-pin-check').classList.add('hidden'); acaoPendente = null; }
        async function confirmarPinAcao() {
            const pinDigitado = document.getElementById('input-check-pin').value;
            const { data } = await sbClient.from('app_config').select('admin_pin').single();
            if(data && data.admin_pin === pinDigitado) { fecharModalPin(); if(acaoPendente) acaoPendente(); } else { alert("PIN Incorreto!"); document.getElementById('input-check-pin').value = ''; }
        }

        // --- FINANCEIRO & BORDERÔ (ATUALIZADO) ---
        async function carregarFinanceiro() {
            const inicio = document.getElementById('data-inicio').value;
            const fim = document.getElementById('data-fim').value;
            const lista = document.getElementById('lista-financeiro');
            
            lista.innerHTML = '<tr><td colspan="5" class="text-center p-4">Carregando dados...</td></tr>';
            
            // Pega config atual para fallback
            const { data: config } = await sbClient.from('app_config').select('*').single();
            
            // Busca pedidos concluídos
            const { data: pedidos } = await sbClient.from('pedidos')
                .select('id, created_at, origem, destino, valor_frete, taxa_app_aplicada')
                .eq('status', 'concluido')
                .gte('created_at', inicio + 'T00:00:00')
                .lte('created_at', fim + 'T23:59:59')
                .order('created_at', {ascending: false});

            let bruto = 0, receitaApp = 0;
            cacheRelatorio = []; // Limpa cache
            lista.innerHTML = '';

            if(!pedidos || !pedidos.length) {
                lista.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Sem movimentação no período.</td></tr>';
            } else {
                pedidos.forEach(p => {
                    const valor = parseFloat(p.valor_frete);
                    
                    // Lógica de Taxa (Prioriza o gravado no pedido, senão usa config atual)
                    let taxaLiq = 0;
                    if(p.taxa_app_aplicada) {
                         // Se foi gravado, assume que é percentual se <= 100, ou fixo se > (?)
                         // Vamos simplificar: Se a config atual diz que é %, tratamos o gravado como %.
                         // O ideal é ter gravado o TIPO também, mas vamos usar a config atual como guia
                         if(config.taxa_app_tipo === 'fixed') taxaLiq = parseFloat(config.taxa_app_percent); // Fallback forçado p/ fixo config
                         else taxaLiq = valor * (p.taxa_app_aplicada / 100);
                    } else {
                        // Fallback total
                        if(config.taxa_app_tipo === 'fixed') taxaLiq = parseFloat(config.taxa_app_percent);
                        else taxaLiq = valor * (config.taxa_app_percent / 100);
                    }
                    
                    const repasse = valor - taxaLiq;
                    bruto += valor;
                    receitaApp += taxaLiq;

                    // Salva para CSV
                    cacheRelatorio.push({
                        id: p.id, data: new Date(p.created_at).toLocaleDateString(),
                        total: valor, repasse: repasse, receita: taxaLiq
                    });

                    // Renderiza Linha
                    lista.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-mono text-xs text-gray-500">#${p.id.slice(0,6)}<br>${new Date(p.created_at).toLocaleDateString()}</td>
                            <td class="p-3 text-xs max-w-[150px] truncate" title="${p.origem} -> ${p.destino}">${p.origem}</td>
                            <td class="p-3 font-bold text-blue-800">R$ ${valor.toFixed(2)}</td>
                            <td class="p-3 text-red-600">R$ ${repasse.toFixed(2)}</td>
                            <td class="p-3 font-bold text-green-600 bg-green-50">R$ ${taxaLiq.toFixed(2)}</td>
                        </tr>`;
                });
            }

            document.getElementById('fin-total').innerText = "R$ " + bruto.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('fin-app').innerText = "R$ " + receitaApp.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('fin-motoboys').innerText = "R$ " + (bruto - receitaApp).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }

        function exportarCSV() {
            if(!cacheRelatorio.length) return alert("Nada para exportar na tela atual.");
            let csv = "ID Pedido;Data;Valor Entrada (Total);Repasse Terceiros;Taxa App (Receita)\n";
            cacheRelatorio.forEach(r => {
                csv += `${r.id};${r.data};${r.total.toFixed(2).replace('.',',')};${r.repasse.toFixed(2).replace('.',',')};${r.receita.toFixed(2).replace('.',',')}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `bordero_drop_${document.getElementById('data-fim').value}.csv`;
            link.click();
        }

        // --- CONFIGURAÇÕES ---
        async function carregarConfig() {
            const { data } = await sbClient.from('app_config').select('*').single();
            if(data) {
                document.getElementById('cfg-base').value = data.taxa_base;
                document.getElementById('cfg-km').value = data.preco_km;
                document.getElementById('cfg-taxa-app').value = data.taxa_app_percent;
                document.getElementById('cfg-retorno-valor').value = data.taxa_retorno_valor;
                setRadio('tipo_taxa', data.taxa_app_tipo || 'percent');
                setRadio('tipo_retorno', data.taxa_retorno_tipo || 'percent');
            }
        }
        function setRadio(name, value) { const el = document.querySelector(`input[name="${name}"][value="${value}"]`); if(el) el.checked = true; }
        
        async function salvarConfig() {
            const updates = {
                taxa_base: document.getElementById('cfg-base').value,
                preco_km: document.getElementById('cfg-km').value,
                taxa_app_percent: document.getElementById('cfg-taxa-app').value,
                taxa_app_tipo: document.querySelector('input[name="tipo_taxa"]:checked').value,
                taxa_retorno_valor: document.getElementById('cfg-retorno-valor').value,
                taxa_retorno_tipo: document.querySelector('input[name="tipo_retorno"]:checked').value
            };
            const { data } = await sbClient.from('app_config').select('id').limit(1);
            if(data[0]) {
                const { error } = await sbClient.from('app_config').update(updates).eq('id', data[0].id);
                if(!error) alert("Configurações Salvas!"); else alert(error.message);
            }
        }

        // --- PREENCHIMENTO DE TABELAS (NOVO) ---
        async function carregarMotoboys() {
            const tb = document.getElementById('lista-motos'); tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Carregando...</td></tr>';
            // Supondo que exista tabela 'motoboys' ou users com role motoboy. Adaptar query conforme DB.
            // Vou usar 'profiles' assumindo filtro por algo, mas como não sei a estrutura exata do motoboy no DB, vou listar profiles que tenham 'placa_moto'
            const { data } = await sbClient.from('profiles').select('*').not('placa_moto', 'is', null);
            tb.innerHTML = '';
            if(!data.length) tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Nenhum motoboy.</td></tr>';
            data.forEach(m => {
                tb.innerHTML += `<tr class="border-b"><td class="p-4 font-bold">${m.responsavel || 'Sem Nome'}</td><td class="p-4 bg-gray-50 font-mono text-xs">${m.placa_moto}</td><td class="p-4">${m.whatsapp_responsavel || '-'}</td><td class="p-4 text-xs text-gray-500">${new Date(m.created_at).toLocaleDateString()}</td></tr>`;
            });
        }

        async function carregarAvaliacoes() {
            const div = document.getElementById('lista-avaliacoes'); div.innerHTML = 'Carregando...';
            // Join com profiles para pegar nome do Motoboy
            const { data } = await sbClient.from('avaliacoes').select('*, profiles(responsavel)').order('created_at', {ascending:false}).limit(20);
            div.innerHTML = '';
            if(!data || !data.length) return div.innerHTML = '<p class="col-span-3 text-center text-gray-400">Sem avaliações ainda.</p>';
            data.forEach(a => {
                const estrelas = '⭐'.repeat(a.nota);
                div.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between mb-2"><span class="font-bold text-gray-700">${a.profiles?.responsavel || 'Motoboy'}</span><span class="text-xs text-gray-400">${new Date(a.created_at).toLocaleDateString()}</span></div>
                        <div class="text-yellow-400 text-lg mb-2">${estrelas}</div>
                        <p class="text-sm text-gray-600 italic">"${a.comentario || 'Sem comentário'}"</p>
                    </div>`;
            });
        }

        // --- MANTER FUNÇÕES ANTIGAS ---
        function nav(view, el) { ['dash', 'motoboys', 'pedidos', 'lojas', 'config', 'avaliacoes', 'perfil'].forEach(v => document.getElementById('view-'+v).classList.add('hidden')); document.getElementById('view-'+view).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
        async function carregarPedidos() { const div=document.getElementById('lista-pedidos'); div.innerHTML='...'; const{data}=await sbClient.from('pedidos').select('*, profiles(nome_loja)').order('created_at',{ascending:false}).limit(20); div.innerHTML=''; if(!data||!data.length)return div.innerHTML='Sem pedidos.'; data.forEach(p=>{ const l=p.profiles?.nome_loja||'Loja'; const cor = p.status==='pendente'?'border-yellow-400':(p.status==='concluido'?'border-green-400':'border-gray-200'); div.innerHTML+=`<div class="bg-white p-4 rounded mb-2 shadow-sm flex justify-between border-l-4 ${cor}"><div><b>#${p.id.substring(0,4)} ${l}</b><br><span class="text-xs uppercase font-bold text-gray-500">${p.status}</span></div><b>R$ ${p.valor_frete}</b></div>`; }); }
        async function carregarLojas(){ const tb=document.getElementById('lista-lojas'); tb.innerHTML=''; const{data}=await sbClient.from('profiles').select('*').not('nome_loja','is',null); data.forEach(l=>{ tb.innerHTML+=`<tr class="border-b"><td class="p-3 font-bold">${l.nome_loja}</td><td class="p-3 text-sm">${l.responsavel||'-'}</td><td class="p-3 font-mono ${l.saldo<0?'text-red-500':'text-green-600'}">R$ ${l.saldo?.toFixed(2)}</td><td class="p-3 text-right"><button onclick="modalSaldo('${l.id}','${l.nome_loja}')" class="bg-blue-50 text-blue-600 px-3 py-1 rounded font-bold hover:bg-blue-100">$ Saldo</button></td></tr>`; }); }
        function modalSaldo(id,n){ document.getElementById('modal-loja-id').value=id; document.getElementById('modal-loja-nome').innerText=n; document.getElementById('modal-saldo').classList.remove('hidden'); }
        function setTipoSaldo(t){ document.getElementById('modal-tipo-saldo').value=t; document.getElementById('btn-credito').className = t==='credito' ? "flex-1 py-2 bg-green-100 text-green-700 rounded-lg font-bold border border-green-200" : "flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg font-bold border border-transparent"; document.getElementById('btn-debito').className = t==='debito' ? "flex-1 py-2 bg-red-100 text-red-700 rounded-lg font-bold border border-red-200" : "flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg font-bold border border-transparent"; }
        async function confirmarSaldo(){ const id=document.getElementById('modal-loja-id').value; const tipo=document.getElementById('modal-tipo-saldo').value; let val=parseFloat(document.getElementById('input-saldo').value); const{data}=await sbClient.from('profiles').select('saldo').eq('id',id).single(); let novo=data.saldo||0; if(tipo==='credito')novo+=val; else novo-=val; const{error}=await sbClient.from('profiles').update({saldo:novo}).eq('id',id); if(!error){ await sbClient.from('transacoes').insert([{user_id:id, tipo:tipo, valor:val, descricao:'Ajuste Admin'}]); alert("Saldo Atualizado!"); document.getElementById('modal-saldo').classList.add('hidden'); carregarLojas(); } }
        async function alterarSenhaLogin(){ const s=document.getElementById('perf-senha-nova').value; if(s.length<6)return alert("Mínimo 6 dígitos"); const{error}=await sbClient.auth.updateUser({password:s}); if(!error){ alert("Senha alterada! Logue novamente."); logout(); }else alert(error.message); }
        async function alterarPinSeguranca(){ const atual=document.getElementById('perf-pin-atual').value; const novo=document.getElementById('perf-pin-novo').value; if(novo.length!==4)return alert("4 dígitos"); const{data}=await sbClient.from('app_config').select('admin_pin, id').single(); if(data.admin_pin&&data.admin_pin!==atual)return alert("PIN Atual incorreto"); await sbClient.from('app_config').update({admin_pin:novo}).eq('id',data.id); alert("PIN Atualizado!"); }
    </script>
</body>
</html>
