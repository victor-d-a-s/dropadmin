<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drop Admin - Painel Mestre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .sidebar { width: 260px; height: 100vh; background: #111827; color: white; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; z-index: 50; }
        .content { margin-left: 260px; padding: 30px; transition: 0.3s; }
        .nav-item { padding: 16px 24px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; color: #9CA3AF; font-size: 14px; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #1F2937; color: #FBBF24; border-right: 3px solid #FBBF24; }
        
        /* Badges e Status */
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .b-pendente { background: #FEF3C7; color: #D97706; }
        .b-aprovado { background: #D1FAE5; color: #059669; }
        .b-bloqueado { background: #FEE2E2; color: #DC2626; }
        
        /* Pedidos */
        .st-solicitado { border-left: 4px solid #FBBF24; background: #FFFBEB; }
        .st-em_rota { border-left: 4px solid #3B82F6; background: #EFF6FF; }
        .st-concluido { border-left: 4px solid #10B981; background: #ECFDF5; }
        .st-cancelado { border-left: 4px solid #EF4444; background: #FEF2F2; opacity: 0.7; }

        .modal-bg { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(2px); }
        .pin-input { letter-spacing: 0.5em; font-family: monospace; text-align: center; font-size: 24px; }
        
        @media (max-width: 768px) { .sidebar { width: 70px; } .sidebar span, .logo-text { display: none; } .content { margin-left: 70px; padding: 15px; } }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-2xl w-96 text-center border border-gray-700 shadow-2xl">
            <i class="fas fa-user-shield text-5xl text-yellow-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-white mb-6">Acesso Mestre</h2>
            <input type="email" id="adm-email" class="w-full bg-gray-900 border border-gray-600 text-white p-3 rounded-lg mb-3" placeholder="E-mail Admin">
            <input type="password" id="adm-senha" class="w-full bg-gray-900 border border-gray-600 text-white p-3 rounded-lg mb-6" placeholder="Senha">
            <button onclick="loginAdmin()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-lg">ENTRAR</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        
        <div class="sidebar">
            <div class="p-6 border-b border-gray-800 flex items-center gap-3">
                <div class="bg-yellow-500 p-2 rounded-lg text-black"><i class="fas fa-cube"></i></div>
                <span class="font-bold text-lg tracking-wide logo-text">DROP <span class="text-yellow-500">ADMIN</span></span>
            </div>
            
            <div class="flex-1 py-6 space-y-1 overflow-y-auto">
                <div class="nav-item active" onclick="nav('dash', this); carregarFinanceiro()"><i class="fas fa-chart-line"></i> <span>Financeiro</span></div>
                <div class="nav-item" onclick="nav('pedidos', this); carregarPedidos()"><i class="fas fa-receipt"></i> <span>Pedidos Live</span></div>
                <div class="nav-item" onclick="nav('motoboys', this); carregarMotoboys()"><i class="fas fa-motorcycle"></i> <span>Entregadores</span></div>
                <div class="nav-item" onclick="nav('avaliacoes', this); carregarAvaliacoes()"><i class="fas fa-star"></i> <span>Avaliações</span></div>
                <div class="nav-item" onclick="nav('lojas', this); carregarLojas()"><i class="fas fa-store"></i> <span>Lojas & Saldo</span></div>
                <div class="nav-item" onclick="nav('config', this); carregarConfig()"><i class="fas fa-cog"></i> <span>Configurações</span></div>
                <div class="nav-item" onclick="nav('perfil', this); carregarPerfil()"><i class="fas fa-user-shield"></i> <span>Perfil & Segurança</span></div>
            </div>
            
            <div class="p-4 border-t border-gray-800">
                <div class="nav-item text-red-400 hover:bg-gray-800" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></div>
            </div>
        </div>

        <div class="content">
            
            <div id="view-dash" class="fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-2xl font-bold text-gray-800">Painel Financeiro</h1>
                    <div class="flex gap-2 bg-white p-2 rounded-lg shadow-sm">
                        <input type="date" id="data-inicio" class="border rounded px-2 py-1 text-sm">
                        <span class="text-gray-400 self-center">até</span>
                        <input type="date" id="data-fim" class="border rounded px-2 py-1 text-sm">
                        <button onclick="carregarFinanceiro()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold hover:bg-blue-700">Filtrar</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-gray-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase">Volume Total (Bruto)</p>
                                <h2 class="text-3xl font-bold text-gray-800 mt-1" id="fin-total">R$ 0,00</h2>
                            </div>
                            <div class="text-gray-300 text-3xl"><i class="fas fa-hand-holding-usd"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Soma de todos os fretes pagos</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-blue-500 text-xs font-bold uppercase">Repasse Motoboys</p>
                                <h2 class="text-3xl font-bold text-gray-800 mt-1" id="fin-motoboys">R$ 0,00</h2>
                            </div>
                            <div class="text-blue-200 text-3xl"><i class="fas fa-motorcycle"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Valor líquido entregadores</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-green-600 text-xs font-bold uppercase">Receita Drop (Taxas)</p>
                                <h2 class="text-3xl font-bold text-gray-800 mt-1" id="fin-app">R$ 0,00</h2>
                            </div>
                            <div class="text-green-200 text-3xl"><i class="fas fa-chart-pie"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Taxa administrativa retida</p>
                    </div>
                </div>
            </div>

            <div id="view-pedidos" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold text-gray-800">Monitor Ao Vivo</h1><button onclick="carregarPedidos()" class="text-blue-600 hover:underline text-sm"><i class="fas fa-sync"></i> Atualizar</button></div>
                <div id="lista-pedidos" class="space-y-3"></div>
            </div>

            <div id="view-motoboys" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Gestão de Entregadores</h1>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase"><tr><th class="p-4">Nome / CPF</th><th class="p-4">Veículo</th><th class="p-4">Contato</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Ação</th></tr></thead><tbody id="lista-motos" class="text-sm text-gray-700"></tbody></table></div>
            </div>

            <div id="view-avaliacoes" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Avaliações dos Parceiros</h1>
                <div id="lista-avaliacoes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>

            <div id="view-lojas" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Lojas e Financeiro</h1>
                <div class="mb-4"><input type="text" id="busca-loja" onkeyup="filtrarLojas()" placeholder="Buscar loja..." class="w-full p-3 border rounded-lg bg-white shadow-sm"></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 border-b border-gray-200 text-xs text-gray-500 uppercase"><tr><th class="p-4">Loja</th><th class="p-4">Responsável</th><th class="p-4">Saldo</th><th class="p-4">Status</th><th class="p-4 text-right">Ações</th></tr></thead><tbody id="lista-lojas" class="text-sm text-gray-700"></tbody></table></div>
            </div>

            <div id="view-config" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Configurações Globais</h1>
                <div class="bg-white p-6 rounded-xl shadow-sm max-w-lg">
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-700 border-b pb-2">Precificação do Cliente</h3>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Taxa Base (R$)</label>
                            <input type="number" id="cfg-base" step="0.50" class="w-full border p-3 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Preço por KM (R$)</label>
                            <input type="number" id="cfg-km" step="0.10" class="w-full border p-3 rounded-lg">
                        </div>
                        
                        <h3 class="font-bold text-gray-700 border-b pb-2 pt-4">Taxas do Aplicativo</h3>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Taxa do App (%) <span class="text-xs text-red-500">*Descontado do valor total</span></label>
                            <input type="number" id="cfg-taxa-app" step="1" max="100" class="w-full border p-3 rounded-lg text-green-700 font-bold">
                            <p class="text-xs text-gray-400 mt-1">Ex: Se frete R$ 10,00 e taxa 10%. Motoboy recebe R$ 9,00. App recebe R$ 1,00.</p>
                        </div>

                        <button onclick="verificarPinParaAcao(salvarConfig)" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 mt-4">
                            <i class="fas fa-save mr-2"></i> SALVAR ALTERAÇÕES (REQUER PIN)
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-perfil" class="hidden fade-in">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Perfil do Administrador</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-2"><i class="fas fa-key text-yellow-500"></i> Alterar Senha de Login</h3>
                        <div class="space-y-3">
                            <input type="password" id="perf-senha-nova" class="w-full border p-3 rounded-lg" placeholder="Nova Senha">
                            <button onclick="alterarSenhaLogin()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-black">Atualizar Senha</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-red-100">
                        <h3 class="font-bold text-red-600 mb-4 border-b pb-2"><i class="fas fa-lock"></i> Alterar PIN de Segurança</h3>
                        <p class="text-xs text-gray-500 mb-3">O PIN é usado para confirmar ações financeiras e configurações críticas.</p>
                        <div class="space-y-3">
                            <input type="password" id="perf-pin-atual" class="w-full border p-3 rounded-lg text-center tracking-widest" placeholder="PIN Atual (4 dígitos)" maxlength="4">
                            <input type="password" id="perf-pin-novo" class="w-full border p-3 rounded-lg text-center tracking-widest font-bold" placeholder="Novo PIN" maxlength="4">
                            <button onclick="alterarPinSeguranca()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">Atualizar PIN</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-pin-check" class="hidden fixed inset-0 modal-bg z-[70] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center">
            <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-2xl"><i class="fas fa-shield-alt"></i></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Acesso Restrito</h3>
            <p class="text-sm text-gray-500 mb-6">Digite seu PIN Mestre para confirmar esta ação.</p>
            <input type="password" id="input-check-pin" maxlength="4" class="w-full border-2 border-gray-300 rounded-xl p-4 pin-input mb-6 focus:border-red-500 outline-none" placeholder="••••">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="fecharModalPin()" class="bg-gray-200 text-gray-700 font-bold py-3 rounded-xl">Cancelar</button>
                <button onclick="confirmarPinAcao()" class="bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modal-saldo" class="hidden fixed inset-0 modal-bg z-[60] flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-2xl animate-fade-in">
            <h3 class="text-lg font-bold text-gray-800 mb-1">Gerenciar Saldo</h3>
            <p id="modal-loja-nome" class="text-sm text-gray-500 mb-4">Loja...</p>
            
            <div class="flex gap-2 mb-3">
                <button onclick="setTipoSaldo('credito')" id="btn-credito" class="flex-1 py-2 bg-green-100 text-green-700 rounded-lg font-bold border border-green-200">Adicionar</button>
                <button onclick="setTipoSaldo('debito')" id="btn-debito" class="flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg font-bold border border-transparent">Remover</button>
            </div>

            <input type="number" id="input-saldo" class="w-full border p-3 rounded-lg text-lg mb-4 font-bold text-gray-800" placeholder="0.00">
            <button onclick="verificarPinParaAcao(confirmarSaldo)" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">Confirmar (Requer PIN)</button>
            <button onclick="document.getElementById('modal-saldo').classList.add('hidden')" class="w-full mt-2 py-2 text-gray-500 text-sm">Cancelar</button>
            
            <input type="hidden" id="modal-loja-id">
            <input type="hidden" id="modal-tipo-saldo" value="credito">
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const SUPABASE_URL = 'https://ofpnnijkhgsjarixoyhg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mcG5uaWpraGdzamFyaXhveWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNjUyNzYsImV4cCI6MjA4MDY0MTI3Nn0.dNOIIETmTz3l1HvhuT-ihAiymJqiaYZnklzzBzDGCFU';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Variável para guardar a função pendente do PIN
        let acaoPendente = null;

        // LOGIN
        async function loginAdmin() {
            const email = document.getElementById('adm-email').value;
            const senha = document.getElementById('adm-senha').value;
            const { error } = await sbClient.auth.signInWithPassword({ email, password: senha });
            if(error) alert("Erro: " + error.message);
            else initSystem();
        }

        function logout() { sbClient.auth.signOut(); location.reload(); }

        window.onload = async () => {
            const { data: { session } } = await sbClient.auth.getSession();
            if(session) initSystem();
            
            // Define datas padrão (Hoje e 30 dias atrás)
            const hoje = new Date();
            const mesAtras = new Date();
            mesAtras.setDate(hoje.getDate() - 30);
            document.getElementById('data-fim').valueAsDate = hoje;
            document.getElementById('data-inicio').valueAsDate = mesAtras;
        };

        function initSystem() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            carregarFinanceiro();
        }

        function nav(view, el) {
            ['dash', 'motoboys', 'pedidos', 'lojas', 'config', 'avaliacoes', 'perfil'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
            document.getElementById('view-'+view).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        // --- SISTEMA DE PIN DE SEGURANÇA ---
        
        function verificarPinParaAcao(funcaoCallback) {
            acaoPendente = funcaoCallback;
            document.getElementById('input-check-pin').value = '';
            document.getElementById('modal-pin-check').classList.remove('hidden');
            document.getElementById('input-check-pin').focus();
        }

        function fecharModalPin() {
            document.getElementById('modal-pin-check').classList.add('hidden');
            acaoPendente = null;
        }

        async function confirmarPinAcao() {
            const pinDigitado = document.getElementById('input-check-pin').value;
            if(pinDigitado.length !== 4) return alert("PIN deve ter 4 dígitos");

            // Valida PIN no banco
            const { data } = await sbClient.from('app_config').select('admin_pin').single();
            const pinReal = data ? data.admin_pin : '0000'; // Default se nulo

            if(pinDigitado === pinReal) {
                fecharModalPin();
                if(acaoPendente) acaoPendente();
            } else {
                alert("PIN INCORRETO!");
                document.getElementById('input-check-pin').value = '';
            }
        }

        // --- DASHBOARD FINANCEIRO ---
        
        async function carregarFinanceiro() {
            const inicio = document.getElementById('data-inicio').value;
            const fim = document.getElementById('data-fim').value;

            // Validação de 90 dias
            const d1 = new Date(inicio);
            const d2 = new Date(fim);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            if(diffDays > 90) return alert("Por favor, selecione um período máximo de 90 dias para otimizar a consulta.");

            // Consulta
            const { data: pedidos } = await sbClient.from('pedidos')
                .select('valor_frete, taxa_app_aplicada')
                .eq('status', 'concluido')
                .gte('created_at', inicio + 'T00:00:00')
                .lte('created_at', fim + 'T23:59:59');

            let bruto = 0;
            let taxaAppTotal = 0;

            if(pedidos) {
                pedidos.forEach(p => {
                    const valor = parseFloat(p.valor_frete);
                    const taxaPercent = parseFloat(p.taxa_app_aplicada || 0);
                    
                    const valorTaxa = valor * (taxaPercent / 100);
                    
                    bruto += valor;
                    taxaAppTotal += valorTaxa;
                });
            }

            const repasseMotoboy = bruto - taxaAppTotal;

            document.getElementById('fin-total').innerText = "R$ " + bruto.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('fin-motoboys').innerText = "R$ " + repasseMotoboy.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('fin-app').innerText = "R$ " + taxaAppTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }

        // --- CONFIGURAÇÃO ---
        
        async function carregarConfig() {
            const { data } = await sbClient.from('app_config').select('*').single();
            if(data) {
                document.getElementById('cfg-base').value = data.taxa_base;
                document.getElementById('cfg-km').value = data.preco_km;
                document.getElementById('cfg-taxa-app').value = data.taxa_app_percent || 10;
            } else {
                await sbClient.from('app_config').insert([{taxa_base: 5, preco_km: 1, taxa_app_percent: 10}]);
                document.getElementById('cfg-base').value = 5; 
                document.getElementById('cfg-km').value = 1;
                document.getElementById('cfg-taxa-app').value = 10;
            }
        }

        async function salvarConfig() {
            const base = document.getElementById('cfg-base').value;
            const km = document.getElementById('cfg-km').value;
            const taxa = document.getElementById('cfg-taxa-app').value;

            const { data } = await sbClient.from('app_config').select('id').limit(1);
            if(data && data.length > 0) {
                const { error } = await sbClient.from('app_config')
                    .update({ taxa_base: base, preco_km: km, taxa_app_percent: taxa })
                    .eq('id', data[0].id);
                if(!error) alert("Configurações atualizadas com sucesso!");
                else alert("Erro: " + error.message);
            }
        }

        // --- AVALIAÇÕES ---
        async function carregarAvaliacoes() {
            const div = document.getElementById('lista-avaliacoes');
            div.innerHTML = '<p class="col-span-3 text-center text-gray-400">Carregando...</p>';
            
            // Join com motoboys para saber quem recebeu a nota
            const { data } = await sbClient.from('avaliacoes')
                .select('*, motoboys(nome, placa)')
                .order('created_at', { ascending: false })
                .limit(50);
                
            div.innerHTML = '';
            if(!data || data.length === 0) {
                div.innerHTML = '<p class="col-span-3 text-center text-gray-400">Nenhuma avaliação encontrada.</p>';
                return;
            }

            data.forEach(av => {
                let stars = '';
                for(let i=0; i<5; i++) {
                    stars += i < av.nota ? '<i class="fas fa-star text-yellow-400"></i>' : '<i class="far fa-star text-gray-300"></i>';
                }

                div.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-bold text-gray-800">${av.motoboys?.nome || 'Desconhecido'}</p>
                                <p class="text-xs text-gray-500">${av.motoboys?.placa || ''}</p>
                            </div>
                            <div class="text-sm">${stars}</div>
                        </div>
                        <p class="text-sm text-gray-600 italic">"${av.comentario || 'Sem comentário'}"</p>
                        <p class="text-xs text-gray-400 mt-3 text-right">${new Date(av.created_at).toLocaleDateString()}</p>
                    </div>
                `;
            });
        }

        // --- PERFIL E SEGURANÇA (FUNÇÕES DO ADMIN) ---

        async function alterarSenhaLogin() {
            const novaSenha = document.getElementById('perf-senha-nova').value;
            if(novaSenha.length < 6) return alert("A senha deve ter no mínimo 6 caracteres.");
            
            // Alteração de senha não precisa do PIN antigo, pois o usuário já está logado
            // Mas poderíamos pedir o PIN mestre por segurança extra. Vamos simplificar.
            const { error } = await sbClient.auth.updateUser({ password: novaSenha });
            
            if(error) alert("Erro ao mudar senha: " + error.message);
            else {
                alert("Senha alterada! Faça login novamente.");
                logout();
            }
        }

        async function alterarPinSeguranca() {
            const pinAtualInput = document.getElementById('perf-pin-atual').value;
            const pinNovo = document.getElementById('perf-pin-novo').value;

            if(pinNovo.length !== 4) return alert("O novo PIN deve ter 4 números.");

            // Verifica PIN atual no banco
            const { data } = await sbClient.from('app_config').select('admin_pin, id').single();
            const pinBanco = data.admin_pin || '0000';

            if(pinAtualInput !== pinBanco) return alert("O PIN atual informado está incorreto.");

            // Atualiza
            const { error } = await sbClient.from('app_config').update({ admin_pin: pinNovo }).eq('id', data.id);
            
            if(error) alert("Erro: " + error.message);
            else {
                alert("PIN de segurança atualizado com sucesso!");
                document.getElementById('perf-pin-atual').value = '';
                document.getElementById('perf-pin-novo').value = '';
            }
        }

        // --- SALDO E LOJAS (MODIFICADO PARA USAR PIN) ---
        function modalSaldo(id, nome) { 
            document.getElementById('modal-loja-id').value = id; 
            document.getElementById('modal-loja-nome').innerText = nome; 
            document.getElementById('input-saldo').value = ''; 
            setTipoSaldo('credito');
            document.getElementById('modal-saldo').classList.remove('hidden'); 
        }

        function setTipoSaldo(tipo) {
            const btnC = document.getElementById('btn-credito');
            const btnD = document.getElementById('btn-debito');
            document.getElementById('modal-tipo-saldo').value = tipo;
            
            if(tipo === 'credito') {
                btnC.className = "flex-1 py-2 bg-green-100 text-green-700 rounded-lg font-bold border border-green-200";
                btnD.className = "flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg font-bold border border-transparent";
            } else {
                btnC.className = "flex-1 py-2 bg-gray-100 text-gray-400 rounded-lg font-bold border border-transparent";
                btnD.className = "flex-1 py-2 bg-red-100 text-red-700 rounded-lg font-bold border border-red-200";
            }
        }

        async function confirmarSaldo() {
            const id = document.getElementById('modal-loja-id').value;
            const tipo = document.getElementById('modal-tipo-saldo').value;
            let valor = parseFloat(document.getElementById('input-saldo').value);
            
            if(!valor || valor <= 0) return alert("Valor inválido");

            const { data } = await sbClient.from('profiles').select('saldo').eq('id', id).single();
            let novoSaldo = data.saldo || 0;
            
            if(tipo === 'credito') novoSaldo += valor;
            else novoSaldo -= valor;

            const { error } = await sbClient.from('profiles').update({ saldo: novoSaldo }).eq('id', id);
            
            if(!error) {
                await sbClient.from('transacoes').insert([{
                    user_id: id,
                    tipo: tipo,
                    valor: valor,
                    descricao: tipo === 'credito' ? 'Recarga via Admin' : 'Débito/Estorno via Admin'
                }]);
                alert("Saldo atualizado com sucesso!");
                document.getElementById('modal-saldo').classList.add('hidden');
                carregarLojas(); // Função existente no seu código (mantive a lógica)
            } else { alert("Erro: " + error.message); }
        }

        // --- FUNÇÕES DE CARREGAMENTO PADRÃO (Mantidas/Adaptadas) ---
        // (Reutilizando as funções de carregarPedidos, carregarLojas e carregarMotoboys 
        //  que já existiam, mas garantindo que chamem as views corretas)
        
        async function carregarPedidos() {
            const div = document.getElementById('lista-pedidos');
            div.innerHTML = '<p class="text-center text-gray-400">Carregando...</p>';
            const { data } = await sbClient.from('pedidos').select('*, profiles(nome_loja), motoboys(nome)').order('created_at', { ascending: false }).limit(50);
            div.innerHTML = '';
            if(!data || data.length === 0) return div.innerHTML = '<p class="text-center text-gray-400">Sem pedidos.</p>';

            data.forEach(p => {
                const loja = p.profiles?.nome_loja || 'Loja Desconhecida';
                const moto = p.motoboys?.nome ? `<i class="fas fa-motorcycle text-xs"></i> ${p.motoboys.nome}` : '<span class="text-gray-400 text-xs">Aguardando...</span>';
                div.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center mb-2">
                        <div>
                            <p class="font-bold text-gray-800">#${p.id} - ${loja}</p>
                            <p class="text-sm text-gray-500">${moto}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">R$ ${p.valor_frete}</p>
                            <span class="text-xs uppercase bg-gray-100 px-2 py-1 rounded">${p.status}</span>
                        </div>
                    </div>`;
            });
        }
        
        let lojasCache = [];
        async function carregarLojas() {
            const tb = document.getElementById('lista-lojas');
            const { data } = await sbClient.from('profiles').select('*').not('nome_loja', 'is', null).order('nome_loja');
            if(data) { lojasCache = data; renderLojas(lojasCache); }
        }

        function renderLojas(lista) {
            const tb = document.getElementById('lista-lojas');
            tb.innerHTML = '';
            lista.forEach(l => {
                const isBloq = l.status === 'Bloqueado';
                const btnBloq = isBloq 
                    ? `<button onclick="verificarPinParaAcao(() => bloquearLoja('${l.id}', 'Ativo'))" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded ml-1">Ativar</button>`
                    : `<button onclick="verificarPinParaAcao(() => bloquearLoja('${l.id}', 'Bloqueado'))" class="text-xs bg-red-100 text-red-500 px-2 py-1 rounded ml-1">Bloquear</button>`;

                tb.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-800">${l.nome_loja}</td>
                        <td class="p-4 text-sm text-gray-600">${l.responsavel || '-'}</td>
                        <td class="p-4 font-mono font-bold text-blue-700">R$ ${(l.saldo || 0).toFixed(2)}</td>
                        <td class="p-4 text-xs font-bold uppercase">${l.status || 'Ativo'}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            ${btnBloq}
                            <button onclick="modalSaldo('${l.id}', '${l.nome_loja}')" class="bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded text-xs font-bold"><i class="fas fa-dollar-sign"></i></button>
                        </td>
                    </tr>`;
            });
        }

        async function bloquearLoja(id, novoStatus) {
            await sbClient.from('profiles').update({ status: novoStatus }).eq('id', id);
            carregarLojas();
        }
        
        function filtrarLojas() { const termo = document.getElementById('busca-loja').value.toLowerCase(); const filt = lojasCache.filter(l => (l.nome_loja || '').toLowerCase().includes(termo)); renderLojas(filt); }

        async function carregarMotoboys() {
            const tb = document.getElementById('lista-motos');
            const { data } = await sbClient.from('motoboys').select('*').order('created_at', {ascending:false});
            tb.innerHTML = '';
            if(!data) return;
            data.forEach(m => {
                let btn = `<button onclick="verificarPinParaAcao(() => altStatus('${m.id}','Aprovado'))" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">APROVAR</button>`;
                if(m.status === 'Aprovado') btn = `<button onclick="verificarPinParaAcao(() => altStatus('${m.id}','Bloqueado'))" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold">BLOQUEAR</button>`;
                tb.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold">${m.nome}</td><td class="p-4">${m.modelo}</td><td class="p-4">${m.whatsapp}</td><td class="p-4 text-center"><span class="badge b-${m.status.toLowerCase()}">${m.status}</span></td><td class="p-4 text-right">${btn}</td></tr>`;
            });
        }
        async function altStatus(id, st) { await sbClient.from('motoboys').update({ status: st }).eq('id', id); carregarMotoboys(); }

    </script>
</body>
</html>
